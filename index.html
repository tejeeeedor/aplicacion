<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Master - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #10b981; --text: #f8fafc; --gray: #94a3b8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 900px; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .full-width { grid-column: 1 / -1; }
        h2 { margin-top: 0; font-size: 1.2rem; color: var(--accent); }
        .habit-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #334155; }
        button { background: var(--accent); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { opacity: 0.8; transform: scale(1.05); }
        .recommendation-box { border-left: 5px solid var(--accent); background: #134e4a; padding: 15px; border-radius: 8px; margin-bottom: 20px; width: 100%; max-width: 860px; }
        input { background: #334155; border: none; padding: 10px; border-radius: 8px; color: white; width: 60%; }
    </style>
</head>
<body>

    <div class="recommendation-box">
        <strong>üí° Recomendaci√≥n del Sistema:</strong>
        <p id="ai-rec">Analizando tus patrones... ¬°Sigue as√≠, vas por buen camino!</p>
    </div>

    <div class="grid">
        <div class="card">
            <h2>Progreso Diario</h2>
            <canvas id="progressChart"></canvas>
        </div>

        <div class="card">
            <h2>Mis H√°bitos</h2>
            <div id="habit-list"></div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <input type="text" id="habit-input" placeholder="Nuevo h√°bito...">
                <button onclick="addHabit()">+</button>
            </div>
        </div>

        <div class="card full-width">
            <h2>Actividad de la Semana</h2>
            <canvas id="weeklyChart" height="80"></canvas>
        </div>
    </div>

    <script>
        // 1. CONFIGURACI√ìN (URL corregida letra por letra)
        const SUPABASE_URL = 'https://nuxnnzrbfrufkjnpgrmp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51eG5uenJiZnJ1ZmtqbnBncm1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMzk2ODAsImV4cCI6MjA4NjgxNTY4MH0.5wf0J-i0t_pRbRxHchib-9bTVTUJ5L1ag2PIe43dzZ0'; 
    
        let habits = [];
        let progressChart, weeklyChart;
    
        // 2. INICIALIZAR GR√ÅFICAS
        function initCharts() {
            const ctx1 = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(ctx1, {
                type: 'doughnut',
                data: { labels: ['Completado', 'Pendiente'], datasets: [{ data: [0, 100], backgroundColor: ['#10b981', '#334155'], borderWidth: 0 }] },
                options: { cutout: '80%' }
            });
    
            const ctx2 = document.getElementById('weeklyChart').getContext('2d');
            weeklyChart = new Chart(ctx2, {
                type: 'bar',
                data: { 
                    labels: ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'], 
                    datasets: [{ label: 'Racha Actual', data: [0, 0, 0, 0, 0, 0, 0], backgroundColor: '#38bdf8' }] 
                }
            });
        }
    
        // 3. DIBUJAR EN PANTALLA
        function render() {
            const list = document.getElementById('habit-list');
            list.innerHTML = '';
            let completedCount = 0;
    
            habits.forEach((h, i) => {
                if(h.completed) completedCount++;
                list.innerHTML += `
                    <div class="habit-row">
                        <span>${h.name} <b>(üî• ${h.streak})</b></span>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="handleToggle(${i})" style="background: ${h.completed ? '#334155' : '#10b981'}">
                                ${h.completed ? 'Deshacer' : 'Logrado'}
                            </button>
                            <button onclick="deleteHabit(${i})" style="background: #ef4444; padding: 8px 10px;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
    
            const percent = (completedCount / habits.length) * 100 || 0;
            if(progressChart) {
                progressChart.data.datasets[0].data = [percent, 100 - percent];
                progressChart.update();
            }
    
            if(weeklyChart) {
                const streaks = habits.slice(0, 7).map(h => h.streak);
                const labels = habits.slice(0, 7).map(h => h.name);
                weeklyChart.data.datasets[0].data = streaks;
                weeklyChart.data.labels = labels.length > 0 ? labels : ['Sin datos'];
                weeklyChart.update();
            }
    
            updateAI(percent);
        }
    
        // 4. CARGAR SUPABASE Y DATOS
        const scriptSupabase = document.createElement('script');
        scriptSupabase.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js';
        document.head.append(scriptSupabase);
    
        let supabaseClient;
        scriptSupabase.onload = async () => {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log("‚úÖ CONECTADO A SUPABASE, SE√ëOR RA√öL");
            
            // Cargar datos justo despu√©s de conectar
            const { data, error } = await supabaseClient.from('habitos').select('*').order('nombre');
            if (!error && data) {
                habits = data.map(h => ({ name: h.nombre, completed: h.completado_hoy, streak: h.racha }));
                console.log("üöÄ DATOS SINCRONIZADOS");
                render();
            }
        };
    
        async function handleToggle(index) {
            habits[index].completed = !habits[index].completed;
            habits[index].streak += habits[index].completed ? 1 : -1;
            render();
    
            if (supabaseClient) {
                await supabaseClient.from('habitos').upsert({ 
                    nombre: habits[index].name, 
                    racha: habits[index].streak, 
                    completado_hoy: habits[index].completed 
                });
            }
        }
    
        async function deleteHabit(index) {
    const nombreBorrar = habits[index].name;
    
    // --- PLANTILLA DE CONFIRMACI√ìN ESTILO SE√ëOR RA√öL ---
    const confirmacion = confirm(
        "‚ö†Ô∏è ¬°ALERTA DE DESTRUCCI√ìN! ‚ö†Ô∏è\n\n" +
        "Se√±or Ra√∫l, ¬øest√° seguro de que desea aniquilar el h√°bito: '" + nombreBorrar + "'?\n\n" +
        "Una vez borrado, desaparecer√° de la base de datos para siempre."
    );

    if (confirmacion) {
        // 1. Lo quitamos de la pantalla
        habits.splice(index, 1);
        render();

        // 2. Lo borramos de la nube (Supabase)
        if (supabaseClient) {
            const { error } = await supabaseClient
                .from('habitos')
                .delete()
                .eq('nombre', nombreBorrar);
            
            if (!error) {
                console.log("üí• H√°bito '" + nombreBorrar + "' eliminado con √©xito.");
            } else {
                console.error("‚ùå Fallo al intentar borrar:", error.message);
            }
        }
    } else {
        console.log("üõ°Ô∏è Sabia decisi√≥n, Se√±or Ra√∫l. El h√°bito ha sido perdonado.");
    }
}
    
        async function addHabit() {
            const val = document.getElementById('habit-input').value;
            if(val) {
                const newHabit = { name: val, completed: false, streak: 0 };
                habits.push(newHabit);
                document.getElementById('habit-input').value = '';
                render();
                if (supabaseClient) {
                    await supabaseClient.from('habitos').insert({ nombre: val, racha: 0, completado_hoy: false });
                }
            }
        }
    
        function updateAI(percent) {
            const rec = document.getElementById('ai-rec');
            rec.innerText = percent === 100 ? "¬°D√≠a perfecto, Se√±or Ra√∫l!" : "Analizando patrones...";
        }
    
        window.onload = () => {
            initCharts();
        };
    </script>
</body>

<div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
    <div style="background: #1e293b; padding: 30px; border-radius: 20px; border: 2px solid #ef4444; max-width: 400px; text-align: center; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); transform: scale(0.9); transition: 0.3s; animation: modalPop 0.3s forwards;">
        <h2 style="color: #ef4444; margin-top: 0;">‚ö†Ô∏è ALERTA DE DESTRUCCI√ìN</h2>
        <p id="modal-text" style="font-size: 1.1rem; line-height: 1.5;">¬øSeguro que desea aniquilar este h√°bito, Se√±or Ra√∫l?</p>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
            <button onclick="closeModal()" style="background: #475569;">PERDONAR</button>
            <button id="confirm-delete-btn" style="background: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);">ANIQUILAR</button>
        </div>
    </div>
</div>

<style>
    @keyframes modalPop {
        to { transform: scale(1); }
    }
</style>
</html>